<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - Quản lý Quyền</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />

    <style>
      body {
        background-color: #f8f9fa;
      }
      .sidebar {
        min-height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      }
      .sidebar-header {
        padding: 1.5rem;
        color: white;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      .nav-btn {
        width: 100%;
        padding: 0.75rem 1.25rem;
        margin-bottom: 0.5rem;
        border: none;
        background: transparent;
        color: rgba(255, 255, 255, 0.8);
        text-align: left;
        border-radius: 0.5rem;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .nav-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        transform: translateX(5px);
      }
      .nav-btn.active {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        font-weight: 600;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .data-table {
        background: white;
        border-radius: 0.5rem;
        overflow: hidden;
      }
      .card {
        border: none;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
      }
    </style>

    <script>
      // Client-side guard: require Admin role, else redirect to home
      (function () {
        try {
          const raw = localStorage.getItem("auth");
          if (!raw) return location.replace("/login.html");
          const auth = JSON.parse(raw);
          const roles = auth?.user?.roles || [];
          if (!Array.isArray(roles) || !roles.includes("Admin")) {
            alert("Bạn không có quyền truy cập trang quản trị.");
            return location.replace("/login.html");
          }
          // Expose token for admin.js
          window.__AUTH__ = auth;
        } catch (e) {
          location.replace("/login.html");
        }
      })();
    </script>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 px-0 sidebar">
          <div class="sidebar-header">
            <h4 class="mb-0">
              <i class="bi bi-shield-lock-fill me-2"></i>Admin Panel
            </h4>
          </div>

          <nav class="sidebar-nav p-3">
            <button class="nav-btn active" data-tab="users">
              <i class="bi bi-people-fill"></i>
              Quản lý Người dùng
            </button>
            <button class="nav-btn" data-tab="permissions">
              <i class="bi bi-key-fill"></i>
              Quản lý Quyền
            </button>
            <button class="nav-btn" data-tab="functions">
              <i class="bi bi-gear-fill"></i>
              Quản lý Chức năng
            </button>
            <button class="nav-btn" data-tab="assign-functions">
              <i class="bi bi-diagram-3-fill"></i>
              Gán Chức năng
            </button>
          </nav>

          <div class="mt-auto p-3">
            <a href="/" class="btn btn-light w-100 mb-2">
              <i class="bi bi-house-fill me-2"></i>Trang người dùng
            </a>
            <button id="logoutBtn" class="btn btn-outline-light w-100">
              <i class="bi bi-box-arrow-right me-2"></i>Đăng xuất
            </button>
          </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9 col-lg-10 px-4 py-4">
          <!-- Users Tab -->
          <div id="users" class="tab-content active">
            <div class="card">
              <div class="card-header bg-white py-3">
                <h4 class="mb-0">
                  <i class="bi bi-people-fill me-2"></i>Quản lý Người dùng
                </h4>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead class="table-light">
                      <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Quyền hiện tại</th>
                      </tr>
                    </thead>
                    <tbody id="usersTable">
                      <tr>
                        <td colspan="3" class="text-center">Đang tải...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Permissions Tab -->
          <div id="permissions" class="tab-content">
            <div class="card">
              <div
                class="card-header bg-white py-3 d-flex justify-content-between align-items-center"
              >
                <h4 class="mb-0">
                  <i class="bi bi-key-fill me-2"></i>Quản lý Quyền
                </h4>
                <button class="btn btn-primary btn-sm" id="addPermissionBtn">
                  <i class="bi bi-plus-circle me-1"></i>Thêm Quyền mới
                </button>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead class="table-light">
                      <tr>
                        <th>ID</th>
                        <th>Tên Quyền</th>
                        <th>Mô tả</th>
                        <th>Ngày tạo</th>
                        <th>Thao tác</th>
                      </tr>
                    </thead>
                    <tbody id="permissionsTable">
                      <tr>
                        <td colspan="5" class="text-center">Đang tải...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Functions Tab -->
          <div id="functions" class="tab-content">
            <div class="card">
              <div class="card-header bg-white py-3">
                <h4 class="mb-0">
                  <i class="bi bi-gear-fill me-2"></i>Quản lý Chức năng
                </h4>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead class="table-light">
                      <tr>
                        <th>ID</th>
                        <th>Mã Chức năng</th>
                        <th>Mô tả</th>
                      </tr>
                    </thead>
                    <tbody id="functionsTable">
                      <tr>
                        <td colspan="3" class="text-center">Đang tải...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Assign Functions Tab -->
          <div id="assign-functions" class="tab-content">
            <div class="card">
              <div class="card-header bg-white py-3">
                <h4 class="mb-0">
                  <i class="bi bi-diagram-3-fill me-2"></i>Gán Chức năng cho
                  Quyền
                </h4>
              </div>
              <div class="card-body">
                <div class="row g-3 mb-3 align-items-end">
                  <div class="col-md-6">
                    <label class="form-label fw-bold">Chọn Quyền (Role):</label>
                    <select id="permissionSelect" class="form-select">
                      <option value="">-- Chọn quyền --</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold"
                      >Chọn Nhóm quyền (Module):</label
                    >
                    <select id="moduleSelect" class="form-select" disabled>
                      <option value="">-- Chọn module --</option>
                    </select>
                  </div>
                </div>

                <div
                  class="d-flex justify-content-between align-items-center mb-2"
                >
                  <div class="text-muted" id="selectionHint">
                    Hãy chọn một module để gán các phần nhỏ
                    (View/Edit/Add/Delete).
                  </div>
                  <div>
                    <div class="form-check form-switch">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        id="toggleAllModule"
                        disabled
                      />
                      <label class="form-check-label" for="toggleAllModule"
                        >Chọn tất cả trong module</label
                      >
                    </div>
                  </div>
                </div>

                <div id="functionsGrid" class="row g-3 mb-4"></div>
                <div class="text-end">
                  <button
                    id="saveAssignmentsBtn"
                    class="btn btn-primary"
                    disabled
                  >
                    <i class="bi bi-save me-2"></i>Lưu Gán Chức năng
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Permission Modal -->
    <div
      class="modal fade"
      id="addPermissionModal"
      tabindex="-1"
      aria-labelledby="addPermissionModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addPermissionModalLabel">
              <i class="bi bi-plus-circle me-2"></i>Thêm Quyền Mới
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="addPermissionForm">
              <div class="mb-3">
                <label for="permissionName" class="form-label"
                  >Tên Quyền *</label
                >
                <select class="form-select" id="permissionName" required>
                  <option value="">-- Chọn loại quyền --</option>
                  <option value="View">View (Xem)</option>
                  <option value="Add">Add (Thêm)</option>
                  <option value="Edit">Edit (Sửa)</option>
                  <option value="Delete">Delete (Xóa)</option>
                </select>
                <div class="form-text">
                  Chọn loại thao tác mà quyền này cho phép
                </div>
              </div>
              <div class="mb-3">
                <label for="permissionModule" class="form-label"
                  >Module *</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="permissionModule"
                  required
                  placeholder="Ví dụ: Order, Customer, Product"
                  maxlength="100"
                />
                <div class="form-text">Tên module mà quyền này áp dụng</div>
              </div>
              <div class="mb-3">
                <label class="form-label">Mô tả quyền</label>
                <div class="alert alert-info mb-0">
                  <strong>View:</strong> Cho phép xem dữ liệu<br />
                  <strong>Add:</strong> Cho phép thêm mới<br />
                  <strong>Edit:</strong> Cho phép chỉnh sửa<br />
                  <strong>Delete:</strong> Cho phép xóa
                </div>
              </div>
              <div id="permissionError" class="alert alert-danger d-none"></div>
              <div
                id="permissionSuccess"
                class="alert alert-success d-none"
              ></div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              <i class="bi bi-x-circle me-1"></i>Hủy
            </button>
            <button
              type="button"
              class="btn btn-primary"
              id="savePermissionBtn"
            >
              <i class="bi bi-check-circle me-1"></i>Tạo Quyền
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/admin.js"></script>
  </body>
</html>
